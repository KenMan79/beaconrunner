<!DOCTYPE html>
<html>
<head><meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>br</title>
  
  
  
  
  <meta property="og:title" content="br" />
  <meta property="og:url" content="https://ethereum.github.io//" />
  <meta property="og:image" content="https://ethereum.github.io/rig/static/rig.png" />
  <meta property="og:description" content="" />

  <script src="https://cdn.jsdelivr.net/npm/underscore@1.13.1/underscore-umd-min.js" type="text/javascript"></script>
  <script src="https://ethereum.github.io/rig/static/react.development.js"></script>
  <script src="https://ethereum.github.io/rig/static/react-dom.development.js"></script>
  <script src="https://ethereum.github.io/rig/static/component-library.js"></script>
  <script src="https://ethereum.github.io/rig/static/header.js"></script>
  <script src="https://ethereum.github.io/rig/static/footer.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.1.10/require.min.js"></script>





<style type="text/css">
    pre { line-height: 125%; }
td.linenos .normal { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
span.linenos { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
td.linenos .special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
span.linenos.special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
.highlight .hll { background-color: var(--jp-cell-editor-active-background) }
.highlight { background: var(--jp-cell-editor-background); color: var(--jp-mirror-editor-variable-color) }
.highlight .c { color: var(--jp-mirror-editor-comment-color); font-style: italic } /* Comment */
.highlight .err { color: var(--jp-mirror-editor-error-color) } /* Error */
.highlight .k { color: var(--jp-mirror-editor-keyword-color); font-weight: bold } /* Keyword */
.highlight .o { color: var(--jp-mirror-editor-operator-color); font-weight: bold } /* Operator */
.highlight .p { color: var(--jp-mirror-editor-punctuation-color) } /* Punctuation */
.highlight .ch { color: var(--jp-mirror-editor-comment-color); font-style: italic } /* Comment.Hashbang */
.highlight .cm { color: var(--jp-mirror-editor-comment-color); font-style: italic } /* Comment.Multiline */
.highlight .cp { color: var(--jp-mirror-editor-comment-color); font-style: italic } /* Comment.Preproc */
.highlight .cpf { color: var(--jp-mirror-editor-comment-color); font-style: italic } /* Comment.PreprocFile */
.highlight .c1 { color: var(--jp-mirror-editor-comment-color); font-style: italic } /* Comment.Single */
.highlight .cs { color: var(--jp-mirror-editor-comment-color); font-style: italic } /* Comment.Special */
.highlight .kc { color: var(--jp-mirror-editor-keyword-color); font-weight: bold } /* Keyword.Constant */
.highlight .kd { color: var(--jp-mirror-editor-keyword-color); font-weight: bold } /* Keyword.Declaration */
.highlight .kn { color: var(--jp-mirror-editor-keyword-color); font-weight: bold } /* Keyword.Namespace */
.highlight .kp { color: var(--jp-mirror-editor-keyword-color); font-weight: bold } /* Keyword.Pseudo */
.highlight .kr { color: var(--jp-mirror-editor-keyword-color); font-weight: bold } /* Keyword.Reserved */
.highlight .kt { color: var(--jp-mirror-editor-keyword-color); font-weight: bold } /* Keyword.Type */
.highlight .m { color: var(--jp-mirror-editor-number-color) } /* Literal.Number */
.highlight .s { color: var(--jp-mirror-editor-string-color) } /* Literal.String */
.highlight .ow { color: var(--jp-mirror-editor-operator-color); font-weight: bold } /* Operator.Word */
.highlight .w { color: var(--jp-mirror-editor-variable-color) } /* Text.Whitespace */
.highlight .mb { color: var(--jp-mirror-editor-number-color) } /* Literal.Number.Bin */
.highlight .mf { color: var(--jp-mirror-editor-number-color) } /* Literal.Number.Float */
.highlight .mh { color: var(--jp-mirror-editor-number-color) } /* Literal.Number.Hex */
.highlight .mi { color: var(--jp-mirror-editor-number-color) } /* Literal.Number.Integer */
.highlight .mo { color: var(--jp-mirror-editor-number-color) } /* Literal.Number.Oct */
.highlight .sa { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Affix */
.highlight .sb { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Backtick */
.highlight .sc { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Char */
.highlight .dl { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Delimiter */
.highlight .sd { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Doc */
.highlight .s2 { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Double */
.highlight .se { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Escape */
.highlight .sh { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Heredoc */
.highlight .si { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Interpol */
.highlight .sx { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Other */
.highlight .sr { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Regex */
.highlight .s1 { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Single */
.highlight .ss { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Symbol */
.highlight .il { color: var(--jp-mirror-editor-number-color) } /* Literal.Number.Integer.Long */
  </style>



<link rel="stylesheet" type="text/css" href="https://ethereum.github.io/rig/static/jupyter.css"/>
<link rel="stylesheet" type="text/css" href="https://ethereum.github.io/rig/static/theme-light.css"/>
<style type="text/css">
a.anchor-link {
   display: none;
}
.highlight  {
    margin: 0.4em;
}

/* Input area styling */
.jp-InputArea {
    overflow: hidden;
}

.jp-InputArea-editor {
    overflow: hidden;
}

@media print {
  body {
    margin: 0;
  }
}
</style>


<!-- Load mathjax -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-MML-AM_CHTML-full,Safe"> </script>
    <!-- MathJax configuration -->
    <script type="text/x-mathjax-config">
    init_mathjax = function() {
        if (window.MathJax) {
        // MathJax loaded
            MathJax.Hub.Config({
                TeX: {
                    equationNumbers: {
                    autoNumber: "AMS",
                    useLabelIds: true
                    }
                },
                tex2jax: {
                    inlineMath: [ ['$','$'], ["\\(","\\)"] ],
                    displayMath: [ ['$$','$$'], ["\\[","\\]"] ],
                    processEscapes: true,
                    processEnvironments: true
                },
                displayAlign: 'center',
                CommonHTML: {
                    linebreaks: { 
                    automatic: true 
                    }
                },
                "HTML-CSS": {
                    linebreaks: { 
                    automatic: true 
                    }
                }
            });
        
            MathJax.Hub.Queue(["Typeset", MathJax.Hub]);
        }
    }
    init_mathjax();
    </script>
    <!-- End of mathjax configuration -->
  <link rel="stylesheet" type="text/css" href="https://ethereum.github.io/rig/static/index.css"/>
</head>
<body class="jp-Notebook" data-jp-theme-light="true" data-jp-theme-name="JupyterLab Light">

  <div id="header"></div>
  <script>
    ReactDOM.render(
      e(Header, null),
      document.querySelector("#header")
    );
    const hamburger = document.querySelector(".hamburger");
    const navMenu = document.querySelector(".nav-menu");

    function mobileMenu() {
        hamburger.classList.toggle("active");
        navMenu.classList.toggle("active");
    }

    function closeMenu() {
        hamburger.classList.remove("active");
        navMenu.classList.remove("active");
    }

    hamburger.addEventListener("click", mobileMenu);

    const navLink = document.querySelectorAll(".nav-link");

    navLink.forEach(n => n.addEventListener("click", closeMenu));
  </script>
  <div class="article-container">
    <div class="document-container">
      <div class="title-container">
        <div class="title">
          Beacon Runner: A BeaconState cadCAD wrap
        </div>

        <div class="sub-title">
          
        </div>
      </div>

      <div id="toc-author-block">
        <div id="authors"></div>
        <div id="toc"></div>
      </div>
      
<div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput " data-mime-type="text/markdown">
<blockquote><p>Note: All code used in this notebook is contained in the <a href="https://github.com/barnabemonnot/beaconrunner/tree/master/notebooks/beaconrunner">notebooks/beaconrunner</a> folder of the Beacon runner repo, and does not use current eth2.0 specs. Most of the content here remains applicable.</p>
</blockquote>
<p>Our goal in this document is to get the specs running in a <a href="https://github.com/BlockScience/cadCAD">cadCAD</a> simulation environment, using the <code>BeaconState</code> object defined in the <a href="https://github.com/ethereum/eth2.0-specs/blob/dev/specs/phase0/beacon-chain.md">eth2 specs</a>. cadCAD is a cool new framework to simulate complex dynamics, in particular in stochastic environments. This makes it ideal to simulate the models of token economics and more generally any system that is controlled by state updates and user interactions. You can learn more about cadCAD by following <a href="https://twitter.com/markusbkoch">Markus Koch</a>'s <a href="https://github.com/BlockScience/cadCAD/tree/master/tutorials">tutorials</a>, especially <a href="https://github.com/BlockScience/cadCAD/blob/master/tutorials/robot-marbles-part-5/robot-marbles-part-5.ipynb">part 5</a> on using class objects as a state variable.</p>
<p>In this notebook, we present the dynamics of block proposers on the beacon chain first, to get a feel of how the chain evolves over time. Then, we introduce validation proper, where validators cast votes to finalise the chain. If we think in game-theoretic terms, here we really just want to understand the basic space of decision-making of the several players in the protocol, as well as the information available to them when such decisions are made. We simplify the presentation by assuming there is no latency and all validators can always access the latest state. A more detailed model will relax these assumptions.</p>
<p>We'll introduce basic building blocks of eth2 as we go along, but there is a ton of resources out there to learn more (<a href="https://hackmd.io/@benjaminion/By6gV_dXS">Ben Edgington's portal</a> is an excellent place to start for instance).</p>
<p>Let's start! We first need to load a bunch of stuff. Make sure you have cadCAD installed, pandas and all the fluff that comes with your favourite Python distribution. Alternatively, find a cool guide <a href="https://community.cadcad.org/t/python-newbies-setup-for-cadcad/101">here</a> to do all that painlessly.</p>

</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs  ">
<details><summary>Input 1 (click to open)</summary>
<div class="jp-Cell-inputWrapper">
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In&nbsp;[1]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
     <div class="CodeMirror cm-s-jupyter">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">constants</span> <span class="kn">import</span> <span class="n">SECONDS_PER_DAY</span><span class="p">,</span> <span class="n">GENESIS_EPOCH</span><span class="p">,</span> <span class="n">SLOTS_PER_HISTORICAL_ROOT</span><span class="p">,</span> <span class="n">MAX_VALIDATORS_PER_COMMITTEE</span>
<span class="kn">from</span> <span class="nn">specs</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">BeaconState</span><span class="p">,</span> <span class="n">BeaconBlock</span><span class="p">,</span> <span class="n">BeaconBlockHeader</span><span class="p">,</span> <span class="n">BeaconBlockBody</span><span class="p">,</span> <span class="n">SignedBeaconBlock</span><span class="p">,</span>
    <span class="n">Deposit</span><span class="p">,</span> <span class="n">DepositData</span><span class="p">,</span> <span class="n">Checkpoint</span><span class="p">,</span> <span class="n">AttestationData</span><span class="p">,</span> <span class="n">Attestation</span><span class="p">,</span>
    <span class="n">initialize_beacon_state_from_eth1</span><span class="p">,</span> <span class="n">get_block_root</span><span class="p">,</span> <span class="n">get_block_root_at_slot</span><span class="p">,</span>
    <span class="n">process_slots</span><span class="p">,</span> <span class="n">process_block</span><span class="p">,</span>
    <span class="n">get_current_epoch</span><span class="p">,</span> <span class="n">get_previous_epoch</span><span class="p">,</span> <span class="n">compute_start_slot_at_epoch</span><span class="p">,</span>
    <span class="n">get_total_active_balance</span><span class="p">,</span> <span class="n">get_committee_assignment</span><span class="p">,</span> <span class="n">get_active_validator_indices</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">ssz_impl</span> <span class="kn">import</span> <span class="p">(</span><span class="n">hash_tree_root</span><span class="p">,</span> <span class="n">signing_root</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">ssz_typing</span> <span class="kn">import</span> <span class="n">Bitlist</span>
<span class="kn">from</span> <span class="nn">hash_function</span> <span class="kn">import</span> <span class="nb">hash</span>
<span class="kn">from</span> <span class="nn">eth2</span> <span class="kn">import</span> <span class="n">eth_to_gwei</span>

<span class="kn">import</span> <span class="nn">secrets</span>

<span class="kn">from</span> <span class="nn">cadCAD.configuration</span> <span class="kn">import</span> <span class="n">Configuration</span>
<span class="kn">from</span> <span class="nn">cadCAD.engine</span> <span class="kn">import</span> <span class="n">ExecutionMode</span><span class="p">,</span> <span class="n">ExecutionContext</span><span class="p">,</span> <span class="n">Executor</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
</pre></div>

     </div>
</div>
</div>
</div>

</details>

</div>
<div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput " data-mime-type="text/markdown">
<h2 id="Genesis-state-and-genesis-block">Genesis state and genesis block<a class="anchor-link" href="#Genesis-state-and-genesis-block">&#182;</a></h2><p>Dynamical systems are usually rather compact to define. We need at the very least two things:</p>
<ul>
<li>Some initial state.</li>
<li>The dynamics, or how state evolves over time.</li>
</ul>
<p>In this part we'll focus on the initial state. We create a dummy genesis state with a bunch of validators (10 of them) who deposit 32 ETH in the contract, the minimum required to start validating.</p>

</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs  ">
<details><summary>Input 2 (click to open)</summary>
<div class="jp-Cell-inputWrapper">
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In&nbsp;[2]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
     <div class="CodeMirror cm-s-jupyter">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Create an array of `Deposit` objects</span>
<span class="k">def</span> <span class="nf">get_initial_deposits</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">Deposit</span><span class="p">(</span>
        <span class="n">data</span><span class="o">=</span><span class="n">DepositData</span><span class="p">(</span>
        <span class="n">amount</span><span class="o">=</span><span class="n">eth_to_gwei</span><span class="p">(</span><span class="mi">32</span><span class="p">),</span>
        <span class="n">pubkey</span><span class="o">=</span><span class="n">secrets</span><span class="o">.</span><span class="n">token_bytes</span><span class="p">(</span><span class="mi">48</span><span class="p">))</span>
    <span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span>
</pre></div>

     </div>
</div>
</div>
</div>

</details>

</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell   ">
<details><summary>Input 3 (click to open)</summary>
<div class="jp-Cell-inputWrapper">
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In&nbsp;[3]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
     <div class="CodeMirror cm-s-jupyter">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">hey</span> <span class="o">=</span> <span class="s2">&quot;hello&quot;</span>
<span class="n">block_hash</span> <span class="o">=</span> <span class="nb">hash</span><span class="p">(</span><span class="n">hey</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">))</span>
<span class="n">eth1_timestamp</span> <span class="o">=</span> <span class="mi">1578009600</span>

<span class="n">genesis_state</span> <span class="o">=</span> <span class="n">initialize_beacon_state_from_eth1</span><span class="p">(</span><span class="n">block_hash</span><span class="p">,</span> <span class="n">eth1_timestamp</span><span class="p">,</span> <span class="n">get_initial_deposits</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">genesis_state</span><span class="o">.</span><span class="n">slot</span><span class="p">)</span>
</pre></div>

     </div>
</div>
</div>
</div>

</details>

<div class="jp-Cell-outputWrapper">


<div class="jp-OutputArea jp-Cell-outputArea">

<div class="jp-OutputArea-child">

    
    <div class="jp-OutputPrompt jp-OutputArea-prompt"></div>


<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain">
<pre>0
</pre>
</div>
</div>

</div>

</div>

</div>
<div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput " data-mime-type="text/markdown">
<p>Let's check the current <em>active</em> balance! (returned here in ETH). We have 10 validators so this should tally up to 320.</p>

</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell   ">
<details><summary>Input 4 (click to open)</summary>
<div class="jp-Cell-inputWrapper">
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In&nbsp;[4]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
     <div class="CodeMirror cm-s-jupyter">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">get_total_active_balance</span><span class="p">(</span><span class="n">genesis_state</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000000000</span>
</pre></div>

     </div>
</div>
</div>
</div>

</details>

<div class="jp-Cell-outputWrapper">


<div class="jp-OutputArea jp-Cell-outputArea">

<div class="jp-OutputArea-child">

    
    <div class="jp-OutputPrompt jp-OutputArea-prompt">Out[4]:</div>




<div class="jp-RenderedText jp-OutputArea-output jp-OutputArea-executeResult" data-mime-type="text/plain">
<pre>320.0</pre>
</div>

</div>

</div>

</div>

</div>
<div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput " data-mime-type="text/markdown">
<p>In the specs, the first block is not proposed by a validator but obtained from the genesis state. We define a function to process the genesis block from the genesis state.</p>

</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs  ">
<details><summary>Input 5 (click to open)</summary>
<div class="jp-Cell-inputWrapper">
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In&nbsp;[5]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
     <div class="CodeMirror cm-s-jupyter">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">process_genesis_block</span><span class="p">(</span><span class="n">genesis_state</span><span class="p">):</span>
    <span class="n">genesis_block</span> <span class="o">=</span> <span class="n">SignedBeaconBlock</span><span class="p">(</span>
        <span class="n">message</span><span class="o">=</span><span class="n">BeaconBlock</span><span class="p">(</span>
            <span class="n">state_root</span><span class="o">=</span><span class="n">hash_tree_root</span><span class="p">(</span><span class="n">genesis_state</span><span class="p">),</span>
            <span class="n">parent_root</span><span class="o">=</span><span class="n">hash_tree_root</span><span class="p">(</span><span class="n">genesis_state</span><span class="o">.</span><span class="n">latest_block_header</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="n">process_block</span><span class="p">(</span><span class="n">genesis_state</span><span class="p">,</span> <span class="n">genesis_block</span><span class="o">.</span><span class="n">message</span><span class="p">)</span>
    
<span class="n">process_genesis_block</span><span class="p">(</span><span class="n">genesis_state</span><span class="p">)</span>
</pre></div>

     </div>
</div>
</div>
</div>

</details>

</div>
<div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput " data-mime-type="text/markdown">
<p>Finally, set the genesis state as the initial condition to our cadCAD execution.</p>

</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs  ">
<details><summary>Input 6 (click to open)</summary>
<div class="jp-Cell-inputWrapper">
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In&nbsp;[6]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
     <div class="CodeMirror cm-s-jupyter">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">initial_conditions</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;beacon_state&#39;</span><span class="p">:</span> <span class="n">genesis_state</span>
<span class="p">}</span>
</pre></div>

     </div>
</div>
</div>
</div>

</details>

</div>
<div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput " data-mime-type="text/markdown">
<h2 id="State-evolution-with-block-proposals">State evolution with block proposals<a class="anchor-link" href="#State-evolution-with-block-proposals">&#182;</a></h2><p>We move on to defining the dynamics. Simple dynamical systems follow some rules to update their state, e.g., the orbits of planets are given by laws derived from attraction. More complex systems are <em>controlled</em>: decisions made by agents in the system influence the state evolution.</p>
<p>In our setting, these agents are validators. State evolution is governed by the rules of the virtual machine, while validators get to decide on blocks and transactions. The resulting state is a combination of agent decisions and state updates. How validators make these decisions is embodied by <em>policy functions</em>: given a state, make a decision.</p>
<p>In eth2, time is subdivided in <em>epochs</em>, themselves divided in <em>slots</em>. At most one block should be proposed at each slot, while accounting for votes and doling out rewards and penalties is done at the end of each epoch. Note that to speed things up in this document, we set the <code>SLOTS_PER_EPOCH</code> constant to 4 in the <code>constants.py</code> file. This is 8x faster than the value in the current specs. (ICO when???)</p>
<p>We now define policies and state updates to run the simulation. Let's take a moment to understand how state transitions work in the <a href="https://github.com/ethereum/eth2.0-specs/blob/dev/specs/phase0/beacon-chain.md">eth2 specs</a>, with notation we introduce here to clarify the different states.</p>
<ol>
<li>Given a slot $s$, define $\omega^-[s]$ as the <em>pre-state</em> of $s$. Once a block $b_s$ is proposed for slot $s$, the specs-defined <code>process_block</code> obtains state $\omega^+[s]$ from $\omega^-[s]$ and $b_s$.</li>
<li>To go from $\omega^+[s]$ to $\omega^-[s+1]$, the specs-defined <code>process_slots</code> caches the block root of $b_s$ and the state root. If $s+1$ is the first slot of a new epoch, <code>process_epoch</code> is called which checks for justification and finalisation of checkpoints as well as attribute rewards and punishments to active validators and process exits and new entries.</li>
<li>From $\omega^-[s+1]$, we repeat the first two steps.</li>
</ol>
<p>Let's talk about the start of this process. The <code>genesis_state</code> object defined above really is $\omega^-[0]$. When we call <code>process_genesis_block</code>, we move to $\omega^+[0]$. This is the <strong>initial condition</strong> of our simulations.</p>
<p>In our simulation, we move the state ahead given a block $b_s$ for slot $s$ from $\omega^+[s-1]$ to $\omega^+[s]$. We will break it down in three steps:</p>
<ol>
<li><strong>(State update)</strong> Process slot <code>s-1</code>, moving from $\omega^+[s-1]$ to $\omega^-[s]$. If a block was proposed during slot $s-1$, the root of the block is cached in the <code>block_roots</code> attribute of $\omega^-[s]$, at index <code>s-1</code>. Otherwise, the root of the most recent block is cached. Additionally, if <code>s-1</code> is the last slot of an epoch, <code>process_epoch</code> is called.</li>
<li><strong>(Policy)</strong> A policy for block proposers to propose a new block $b_s$ at slot $s$.</li>
<li><strong>(State update)</strong> Process block $b_s$, taking $\omega^-[s]$ to $\omega^+[s]$.</li>
</ol>
<p>Let's do this step by step:</p>
<h3 id="Process-slot">Process slot<a class="anchor-link" href="#Process-slot">&#182;</a></h3><p>The arguments of this function are given to us by the cadCAD execution environment. <code>s</code> holds the current state of the simulation, where <code>s['beacon_state']</code> returns the current beacon state. Remember that we had set the initial state $\omega^+[0]$ as the <code>beacon_state</code> attribute of the <code>initial_conditions</code> dictionary.</p>

</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs  ">
<details><summary>Input 7 (click to open)</summary>
<div class="jp-Cell-inputWrapper">
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In&nbsp;[7]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
     <div class="CodeMirror cm-s-jupyter">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">state_update_slot</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">sL</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">_input</span><span class="p">):</span>
    <span class="c1"># Given state w+[s], transition to w-[s+1]</span>
    
    <span class="c1"># state is w+[s]</span>
    <span class="n">state</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;beacon_state&#39;</span><span class="p">]</span>
    
    <span class="n">process_slots</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">slot</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="p">(</span><span class="s1">&#39;beacon_state&#39;</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</pre></div>

     </div>
</div>
</div>
</div>

</details>

</div>
<div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput " data-mime-type="text/markdown">
<h3 id="Propose-a-block">Propose a block<a class="anchor-link" href="#Propose-a-block">&#182;</a></h3><p>We have more latitude to define what happens at this step. We can for instance make the difference between an honest validator who returns a block when they are the block proposer, given the most current state, and an offline validator who just does not produce anything. Given a state, each will return a different item.</p>

</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs  ">
<details><summary>Input 8 (click to open)</summary>
<div class="jp-Cell-inputWrapper">
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In&nbsp;[8]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
     <div class="CodeMirror cm-s-jupyter">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">honest_block_proposal</span><span class="p">(</span><span class="n">state</span><span class="p">):</span>
    <span class="c1"># State is w-[s], block will be proposed for slot s</span>
    
    <span class="c1"># Later on, we populate the `BeaconBlockBody`. For now, our validators merely produce empty blocks.</span>
    <span class="n">beacon_block_body</span> <span class="o">=</span> <span class="n">BeaconBlockBody</span><span class="p">()</span>
    
    <span class="n">beacon_block</span> <span class="o">=</span> <span class="n">BeaconBlock</span><span class="p">(</span>
        <span class="n">slot</span><span class="o">=</span><span class="n">state</span><span class="o">.</span><span class="n">slot</span><span class="p">,</span>
        <span class="c1"># the parent root is accessed from the state</span>
        <span class="n">parent_root</span><span class="o">=</span><span class="n">get_block_root_at_slot</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">slot</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span>
        <span class="n">body</span><span class="o">=</span><span class="n">beacon_block_body</span>
    <span class="p">)</span>
    <span class="n">signed_beacon_block</span> <span class="o">=</span> <span class="n">SignedBeaconBlock</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="n">beacon_block</span><span class="p">)</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;honest propose a block for slot&quot;</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">slot</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">signed_beacon_block</span>
</pre></div>

     </div>
</div>
</div>
</div>

</details>

</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs  ">
<details><summary>Input 9 (click to open)</summary>
<div class="jp-Cell-inputWrapper">
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In&nbsp;[9]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
     <div class="CodeMirror cm-s-jupyter">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">offline_block_proposal</span><span class="p">(</span><span class="n">state</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;offline propose nothing for slot&quot;</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">slot</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">None</span>
</pre></div>

     </div>
</div>
</div>
</div>

</details>

</div>
<div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput " data-mime-type="text/markdown">
<p>We now define the policy function of step 2, again using the arguments that the cadCAD environment gives us. In this simulation, we'll assume that an honest and an offline validator propose in turn, so we only have blocks on even slots.</p>

</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs  ">
<details><summary>Input 10 (click to open)</summary>
<div class="jp-Cell-inputWrapper">
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In&nbsp;[10]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
     <div class="CodeMirror cm-s-jupyter">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">propose_block</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">sL</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
    <span class="c1"># Given state w-[s], propose a block for slot s</span>
    
    <span class="c1"># `state` is w-[s]</span>
    <span class="n">state</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;beacon_state&#39;</span><span class="p">]</span>
    
    <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">slot</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">block</span> <span class="o">=</span> <span class="n">honest_block_proposal</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">block</span> <span class="o">=</span> <span class="n">offline_block_proposal</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
        
    <span class="k">return</span> <span class="p">({</span> <span class="s1">&#39;block&#39;</span><span class="p">:</span> <span class="n">block</span> <span class="p">})</span>
</pre></div>

     </div>
</div>
</div>
</div>

</details>

</div>
<div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput " data-mime-type="text/markdown">
<h3 id="Process-the-block">Process the block<a class="anchor-link" href="#Process-the-block">&#182;</a></h3><p>Given a block, we can run the state transition by calling <code>process_block</code>. We get the block proposed in step 2 as the <code>block</code> attribute of <code>_input</code>.</p>

</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs  ">
<details><summary>Input 11 (click to open)</summary>
<div class="jp-Cell-inputWrapper">
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In&nbsp;[11]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
     <div class="CodeMirror cm-s-jupyter">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">state_update_block</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">sL</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">_input</span><span class="p">):</span>
    <span class="n">state</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;beacon_state&#39;</span><span class="p">]</span>
    <span class="n">block</span> <span class="o">=</span> <span class="n">_input</span><span class="p">[</span><span class="s1">&#39;block&#39;</span><span class="p">]</span>
    
    <span class="k">if</span> <span class="n">block</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># No change to the state</span>
        <span class="k">return</span> <span class="p">(</span><span class="s1">&#39;beacon_state&#39;</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
    
    <span class="c1"># Otherwise we process the block first and return the state</span>
    <span class="n">process_block</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">block</span><span class="o">.</span><span class="n">message</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="p">(</span><span class="s1">&#39;beacon_state&#39;</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span>
</pre></div>

     </div>
</div>
</div>
</div>

</details>

</div>
<div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput " data-mime-type="text/markdown">
<h2 id="Putting-it-all-together">Putting it all together<a class="anchor-link" href="#Putting-it-all-together">&#182;</a></h2><p>The previous three steps are recorded in the <code>block_proposal_psub</code> array. <code>psub</code> stands for <em>partial state updates blocks</em>, the building blocks of a cadCAD simulation.</p>

</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs  ">
<details><summary>Input 12 (click to open)</summary>
<div class="jp-Cell-inputWrapper">
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In&nbsp;[12]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
     <div class="CodeMirror cm-s-jupyter">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">block_proposal_psub</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="s1">&#39;policies&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="p">},</span>
        <span class="s1">&#39;variables&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;beacon_state&#39;</span><span class="p">:</span> <span class="n">state_update_slot</span> <span class="c1"># step 1</span>
        <span class="p">}</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="s1">&#39;policies&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="n">propose_block</span> <span class="c1"># step 2</span>
        <span class="p">},</span>
        <span class="s1">&#39;variables&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;beacon_state&#39;</span><span class="p">:</span> <span class="n">state_update_block</span> <span class="c1"># step 3</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">]</span>
</pre></div>

     </div>
</div>
</div>
</div>

</details>

</div>
<div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput " data-mime-type="text/markdown">
<h3 id="Execution">Execution<a class="anchor-link" href="#Execution">&#182;</a></h3><p>We first give parameters to run the simulation. The <code>T</code> variable corresponds to slots in the beacon chain execution.</p>

</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs  ">
<details><summary>Input 13 (click to open)</summary>
<div class="jp-Cell-inputWrapper">
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In&nbsp;[13]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
     <div class="CodeMirror cm-s-jupyter">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">simulation_parameters</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;T&#39;</span><span class="p">:</span> <span class="nb">range</span><span class="p">(</span><span class="mi">15</span><span class="p">),</span>
    <span class="s1">&#39;N&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s1">&#39;M&#39;</span><span class="p">:</span> <span class="p">{}</span>
<span class="p">}</span>
</pre></div>

     </div>
</div>
</div>
</div>

</details>

</div>
<div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput " data-mime-type="text/markdown">
<p>We set up our cadCAD execution with the pieces we created above.</p>

</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell   ">
<details><summary>Input 14 (click to open)</summary>
<div class="jp-Cell-inputWrapper">
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In&nbsp;[14]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
     <div class="CodeMirror cm-s-jupyter">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">config</span> <span class="o">=</span> <span class="n">Configuration</span><span class="p">(</span><span class="n">initial_state</span><span class="o">=</span><span class="n">initial_conditions</span><span class="p">,</span>
                       <span class="n">partial_state_update_blocks</span><span class="o">=</span><span class="n">block_proposal_psub</span><span class="p">,</span>
                       <span class="n">sim_config</span><span class="o">=</span><span class="n">simulation_parameters</span>
                      <span class="p">)</span>
</pre></div>

     </div>
</div>
</div>
</div>

</details>

<div class="jp-Cell-outputWrapper">


<div class="jp-OutputArea jp-Cell-outputArea">

<div class="jp-OutputArea-child">

    
    <div class="jp-OutputPrompt jp-OutputArea-prompt"></div>


<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="application/vnd.jupyter.stderr">
<pre>
<span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">TypeError</span>                                 Traceback (most recent call last)
<span class="ansi-green-fg">&lt;ipython-input-14-ba54fd5a3b38&gt;</span> in <span class="ansi-cyan-fg">&lt;module&gt;</span>
<span class="ansi-green-fg">----&gt; 1</span><span class="ansi-red-fg"> config = Configuration(initial_state=initial_conditions,
</span><span class="ansi-green-intense-fg ansi-bold">      2</span>                        partial_state_update_blocks<span class="ansi-blue-fg">=</span>block_proposal_psub<span class="ansi-blue-fg">,</span>
<span class="ansi-green-intense-fg ansi-bold">      3</span>                        sim_config<span class="ansi-blue-fg">=</span>simulation_parameters
<span class="ansi-green-intense-fg ansi-bold">      4</span>                       )

<span class="ansi-red-fg">TypeError</span>: __init__() missing 3 required positional arguments: &#39;user_id&#39;, &#39;subset_id&#39;, and &#39;subset_window&#39;</pre>
</div>
</div>

</div>

</div>

</div>
<div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput " data-mime-type="text/markdown">
<p>Run it! (This may take some time)</p>

</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell   ">
<details><summary>Input 15 (click to open)</summary>
<div class="jp-Cell-inputWrapper">
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In&nbsp;[15]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
     <div class="CodeMirror cm-s-jupyter">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">exec_mode</span> <span class="o">=</span> <span class="n">ExecutionMode</span><span class="p">()</span>
<span class="n">exec_context</span> <span class="o">=</span> <span class="n">ExecutionContext</span><span class="p">(</span><span class="n">exec_mode</span><span class="o">.</span><span class="n">single_proc</span><span class="p">)</span>
<span class="n">executor</span> <span class="o">=</span> <span class="n">Executor</span><span class="p">(</span><span class="n">exec_context</span><span class="p">,</span> <span class="p">[</span><span class="n">config</span><span class="p">])</span> <span class="c1"># Pass the configuration object inside an array</span>
<span class="n">raw_result</span><span class="p">,</span> <span class="n">tensor</span> <span class="o">=</span> <span class="n">executor</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span> <span class="c1"># The `execute()` method returns a tuple; its first elements contains the raw results</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">raw_result</span><span class="p">)</span>
</pre></div>

     </div>
</div>
</div>
</div>

</details>

<div class="jp-Cell-outputWrapper">


<div class="jp-OutputArea jp-Cell-outputArea">

<div class="jp-OutputArea-child">

    
    <div class="jp-OutputPrompt jp-OutputArea-prompt"></div>


<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain">
<pre>
                            __________   ____ 
          ________ __ _____/ ____/   |  / __ \
         / ___/ __` / __  / /   / /| | / / / /
        / /__/ /_/ / /_/ / /___/ ___ |/ /_/ / 
        \___/\__,_/\__,_/\____/_/  |_/_____/  
        by BlockScience
        
Execution Mode: single_proc: [&lt;cadCAD.configuration.Configuration object at 0x124cb07f0&gt;]
Configurations: [&lt;cadCAD.configuration.Configuration object at 0x124cb07f0&gt;]
offline propose nothing for slot 1
honest propose a block for slot 2
offline propose nothing for slot 3
START PROCESS EPOCH 0
not processing justification and finalization
END PROCESS EPOCH
honest propose a block for slot 4
offline propose nothing for slot 5
honest propose a block for slot 6
offline propose nothing for slot 7
START PROCESS EPOCH 1
not processing justification and finalization
END PROCESS EPOCH
honest propose a block for slot 8
offline propose nothing for slot 9
honest propose a block for slot 10
offline propose nothing for slot 11
START PROCESS EPOCH 2
old_previous 0
old_current 0
justification bits Bitvector[boolean, 4](0, 0, 0, 0)
finalised checkpoint 0
END PROCESS EPOCH
honest propose a block for slot 12
offline propose nothing for slot 13
honest propose a block for slot 14
offline propose nothing for slot 15
</pre>
</div>
</div>

</div>

</div>

</div>
<div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput " data-mime-type="text/markdown">
<p>The historical sequence of states is held in the <code>df</code> dataframe, let's take a look.</p>

</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell   ">
<details><summary>Input 16 (click to open)</summary>
<div class="jp-Cell-inputWrapper">
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In&nbsp;[16]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
     <div class="CodeMirror cm-s-jupyter">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;latest_block_root&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">beacon_state</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">state</span><span class="p">:</span> <span class="n">hash_tree_root</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">latest_block_header</span><span class="p">)</span><span class="o">.</span><span class="n">hex</span><span class="p">()[</span><span class="mi">0</span><span class="p">:</span><span class="mi">6</span><span class="p">])</span>
<span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="mi">2</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span>
</pre></div>

     </div>
</div>
</div>
</div>

</details>

<div class="jp-Cell-outputWrapper">


<div class="jp-OutputArea jp-Cell-outputArea">

<div class="jp-OutputArea-child">

    
    <div class="jp-OutputPrompt jp-OutputArea-prompt">Out[16]:</div>



<div class="jp-RenderedHTMLCommon jp-RenderedHTML jp-OutputArea-output jp-OutputArea-executeResult" data-mime-type="text/html">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>substep</th>
      <th>timestep</th>
      <th>latest_block_root</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0</td>
      <td>0</td>
      <td>89f88d</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>1</td>
      <td>d0edc3</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2</td>
      <td>1</td>
      <td>d0edc3</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1</td>
      <td>2</td>
      <td>d0edc3</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2</td>
      <td>2</td>
      <td>4db981</td>
    </tr>
    <tr>
      <th>5</th>
      <td>1</td>
      <td>3</td>
      <td>3b1cce</td>
    </tr>
    <tr>
      <th>6</th>
      <td>2</td>
      <td>3</td>
      <td>3b1cce</td>
    </tr>
    <tr>
      <th>7</th>
      <td>1</td>
      <td>4</td>
      <td>3b1cce</td>
    </tr>
    <tr>
      <th>8</th>
      <td>2</td>
      <td>4</td>
      <td>ad4be3</td>
    </tr>
    <tr>
      <th>9</th>
      <td>1</td>
      <td>5</td>
      <td>600744</td>
    </tr>
    <tr>
      <th>10</th>
      <td>2</td>
      <td>5</td>
      <td>600744</td>
    </tr>
    <tr>
      <th>11</th>
      <td>1</td>
      <td>6</td>
      <td>600744</td>
    </tr>
    <tr>
      <th>12</th>
      <td>2</td>
      <td>6</td>
      <td>fa7b5f</td>
    </tr>
    <tr>
      <th>13</th>
      <td>1</td>
      <td>7</td>
      <td>842e3a</td>
    </tr>
    <tr>
      <th>14</th>
      <td>2</td>
      <td>7</td>
      <td>842e3a</td>
    </tr>
    <tr>
      <th>15</th>
      <td>1</td>
      <td>8</td>
      <td>842e3a</td>
    </tr>
    <tr>
      <th>16</th>
      <td>2</td>
      <td>8</td>
      <td>dd2071</td>
    </tr>
    <tr>
      <th>17</th>
      <td>1</td>
      <td>9</td>
      <td>8ba647</td>
    </tr>
    <tr>
      <th>18</th>
      <td>2</td>
      <td>9</td>
      <td>8ba647</td>
    </tr>
    <tr>
      <th>19</th>
      <td>1</td>
      <td>10</td>
      <td>8ba647</td>
    </tr>
    <tr>
      <th>20</th>
      <td>2</td>
      <td>10</td>
      <td>d815fe</td>
    </tr>
    <tr>
      <th>21</th>
      <td>1</td>
      <td>11</td>
      <td>5a9627</td>
    </tr>
    <tr>
      <th>22</th>
      <td>2</td>
      <td>11</td>
      <td>5a9627</td>
    </tr>
    <tr>
      <th>23</th>
      <td>1</td>
      <td>12</td>
      <td>5a9627</td>
    </tr>
    <tr>
      <th>24</th>
      <td>2</td>
      <td>12</td>
      <td>445c7d</td>
    </tr>
    <tr>
      <th>25</th>
      <td>1</td>
      <td>13</td>
      <td>7ee01c</td>
    </tr>
    <tr>
      <th>26</th>
      <td>2</td>
      <td>13</td>
      <td>7ee01c</td>
    </tr>
    <tr>
      <th>27</th>
      <td>1</td>
      <td>14</td>
      <td>7ee01c</td>
    </tr>
    <tr>
      <th>28</th>
      <td>2</td>
      <td>14</td>
      <td>7bc532</td>
    </tr>
    <tr>
      <th>29</th>
      <td>1</td>
      <td>15</td>
      <td>7ad11c</td>
    </tr>
    <tr>
      <th>30</th>
      <td>2</td>
      <td>15</td>
      <td>7ad11c</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>

</div>

</div>
<div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput " data-mime-type="text/markdown">
<p>We give the last few bytes of the latest block header root in the state. Timesteps virtually represent slots of the beacon chain. For each timestep, we have two substeps since we have two partial state update blocks.</p>
<ul>
<li>At timestep <code>s</code> and substep 1, the state is $\omega^-[s]$.</li>
<li>At timestep <code>s</code> and substep 2, the state is $\omega^+[s]$.</li>
</ul>
<p><em>Note:</em> The block root does not change during odd timesteps. This is because we have offline validators who do not propose blocks then.</p>
<p><em>Also note:</em> The latest block root in substep 2 of even timesteps is unique. Before we process the slot, the <code>state_root</code> attribute of the latest block header saved in the state is not set. When we process the slot, this state root is set and this changes the <code>latest_block_root</code> hash.</p>
<p>Finally, we can check whether checkpoints (i.e., blocks between epochs) are being finalised, which is why we care about the beacon chain in the first place.</p>

</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell   ">
<details><summary>Input 17 (click to open)</summary>
<div class="jp-Cell-inputWrapper">
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In&nbsp;[17]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
     <div class="CodeMirror cm-s-jupyter">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">30</span><span class="p">][</span><span class="s1">&#39;beacon_state&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">finalized_checkpoint</span>
</pre></div>

     </div>
</div>
</div>
</div>

</details>

<div class="jp-Cell-outputWrapper">


<div class="jp-OutputArea jp-Cell-outputArea">

<div class="jp-OutputArea-child">

    
    <div class="jp-OutputPrompt jp-OutputArea-prompt">Out[17]:</div>




<div class="jp-RenderedText jp-OutputArea-output jp-OutputArea-executeResult" data-mime-type="text/plain">
<pre>{&#39;epoch&#39;: 0, &#39;root&#39;: b&#39;\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00&#39;}</pre>
</div>

</div>

</div>

</div>

</div>
<div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput " data-mime-type="text/markdown">
<p>Nope! The last finalised checkpoint is still the genesis block. The blocks are empty since we restricted validators to their block proposer roles. Time to have them vote on the canonical chain and start finalising!</p>

</div>
<div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput " data-mime-type="text/markdown">
<h2 id="Once-more-with-attestations">Once more with attestations<a class="anchor-link" href="#Once-more-with-attestations">&#182;</a></h2><p>We create new policies to make validators attest on the blocks of the beacon chain. Attestations are "votes" in the FFG gadget, committing to checkpoints and beacon chain blocks. <em>All</em> active validators are called on to produce one attestation during each epoch. Each validator is assigned to <em>one</em> slot to make the attestation at, preferably right after they have received the block proposed for that slot.</p>
<p>So attestations should contain:</p>
<ul>
<li>A <em>source</em> attribute: the last justified checkpoint the validator knows about.</li>
<li>A <em>target</em> attribute: the last non-justified checkpoint the validator knows about.</li>
<li>A <em>head</em> attribute: what the validator sees as the current tip of the beacon chain, preferably the block proposed for their assigned slot.</li>
<li>A <em>slot</em> attribute: the slot assigned to the validator.</li>
</ul>
<p>Admittedly, we are cheating a bit here. Since we assume our validators are honest and there is no latency, they are instantly up-to-date with the latest chain state, so we can use the <code>BeaconState</code> attributes to form validator attestations. In reality, validators should run the fork choice to decide which is the head of the beacon chain.</p>
<p>We start at some state $\omega^+[s-1]$, i.e., the post-state of slot $s-1$.</p>
<ol>
<li><strong>(State update)</strong> We move the state from $\omega^+[s-1]$ to $\omega^-[s]$.</li>
<li><strong>(Policy)</strong> Validators at state $\omega^-[s]$ make attestations for slot $s-1$. These attestations contain a source and target for their FFG vote and the head of the chain according to their view of the beacon chain (in this case, $b_{s-1}$).</li>
<li><strong>(State update)</strong> These attestations are kept in the simulation state space as <code>current_slot_attestations</code>.</li>
<li><strong>(Policy)</strong> Someone proposes a block $b_s$ at slot $s$. Note that $b_s$ contains attestations made by validators in committees at slot $s-1$, which are kept in <code>current_slot_attestations</code>.</li>
<li><strong>(State update)</strong> The state transitions to $\omega^+[s]$ when the block is processed.</li>
</ol>

</div>
<div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput " data-mime-type="text/markdown">
<h3 id="Process-slot">Process slot<a class="anchor-link" href="#Process-slot">&#182;</a></h3><p>We already have a state transition function for that, our previously defined <code>state_update_slot</code>.</p>

</div>
<div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput " data-mime-type="text/markdown">
<h3 id="Attestation-policy">Attestation policy<a class="anchor-link" href="#Attestation-policy">&#182;</a></h3><p>Let's focus on the new step here, step #2. We first need to create honest attestations from validators.</p>

</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs  ">
<details><summary>Input 18 (click to open)</summary>
<div class="jp-Cell-inputWrapper">
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In&nbsp;[18]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
     <div class="CodeMirror cm-s-jupyter">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">honest_attest</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">validator_index</span><span class="p">):</span>
    <span class="c1"># Given state w-[s], validators in committees of slot `s-1` form their attestations</span>
    <span class="c1"># In several places here, we need to check whether `s` is the first slot of a new epoch.</span>
    
    <span class="n">current_epoch</span> <span class="o">=</span> <span class="n">get_current_epoch</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
    <span class="n">previous_epoch</span> <span class="o">=</span> <span class="n">get_previous_epoch</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
    
    <span class="c1"># Since everyone is honest, we can assume that validators attesting during some epoch e</span>
    <span class="c1"># choose the first block of e as their target, and the first block of e-1 as their source</span>
    <span class="c1"># checkpoint.</span>
    <span class="c1">#</span>
    <span class="c1"># So let&#39;s assume the validator here is making an attestation at slot s in epoch e:</span>
    <span class="c1">#</span>
    <span class="c1"># - If the `state` variable is at epoch e, then the first block of epoch e-1 is</span>
    <span class="c1"># a checkpoint held in `state.current_justified_checkpoint`.</span>
    <span class="c1"># The target checkpoint root is obtained by calling</span>
    <span class="c1"># `get_block_root(state, current_epoch)` (since current_epoch = e).</span>
    <span class="c1">#</span>
    <span class="c1"># - If the `state` variable is at epoch e+1, then the first block of epoch e-1</span>
    <span class="c1"># is a checkpoint held in `state.previous_justified_checkpoint`,</span>
    <span class="c1"># since in the meantime the first block of e was justified.</span>
    <span class="c1"># This is the case when s is the last slot of epoch e.</span>
    <span class="c1"># The target checkpoint root is obtained by calling</span>
    <span class="c1"># `get_block_root(state, previous_epoch)` (since current_epoch = e+1).</span>
    <span class="c1">#</span>
    <span class="c1"># ... still here?</span>
    
    <span class="c1"># If `state` is already at the start of a new epoch e+1</span>
    <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">slot</span> <span class="o">==</span> <span class="n">compute_start_slot_at_epoch</span><span class="p">(</span><span class="n">current_epoch</span><span class="p">):</span>
        <span class="c1"># `committee_slot` is equal to s-1</span>
        <span class="p">(</span><span class="n">committee</span><span class="p">,</span> <span class="n">committee_index</span><span class="p">,</span> <span class="n">committee_slot</span><span class="p">)</span> <span class="o">=</span> <span class="n">get_committee_assignment</span><span class="p">(</span>
            <span class="n">state</span><span class="p">,</span> <span class="n">previous_epoch</span><span class="p">,</span> <span class="n">validator_index</span>
        <span class="p">)</span>
        
        <span class="c1"># Since we are at state w-[s], we can get the block root of the block at slot s-1.</span>
        <span class="n">block_root</span> <span class="o">=</span> <span class="n">get_block_root_at_slot</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">committee_slot</span><span class="p">)</span>
        
        <span class="n">src_checkpoint</span> <span class="o">=</span> <span class="n">Checkpoint</span><span class="p">(</span>
            <span class="n">epoch</span><span class="o">=</span><span class="n">state</span><span class="o">.</span><span class="n">previous_justified_checkpoint</span><span class="o">.</span><span class="n">epoch</span><span class="p">,</span>
            <span class="n">root</span><span class="o">=</span><span class="n">state</span><span class="o">.</span><span class="n">previous_justified_checkpoint</span><span class="o">.</span><span class="n">root</span>
        <span class="p">)</span>
        
        <span class="n">tgt_checkpoint</span> <span class="o">=</span> <span class="n">Checkpoint</span><span class="p">(</span>
            <span class="n">epoch</span><span class="o">=</span><span class="n">previous_epoch</span><span class="p">,</span>
            <span class="n">root</span><span class="o">=</span><span class="n">get_block_root</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">previous_epoch</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="c1"># Otherwise, if `state` is at epoch e</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># `committee_slot` is equal to s-1</span>
        <span class="p">(</span><span class="n">committee</span><span class="p">,</span> <span class="n">committee_index</span><span class="p">,</span> <span class="n">committee_slot</span><span class="p">)</span> <span class="o">=</span> <span class="n">get_committee_assignment</span><span class="p">(</span>
            <span class="n">state</span><span class="p">,</span> <span class="n">current_epoch</span><span class="p">,</span> <span class="n">validator_index</span>
        <span class="p">)</span>
        
        <span class="c1"># Since we are at state w-[s], we can get the block root of the block at slot s-1.</span>
        <span class="n">block_root</span> <span class="o">=</span> <span class="n">get_block_root_at_slot</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">committee_slot</span><span class="p">)</span>
        
        <span class="n">src_checkpoint</span> <span class="o">=</span> <span class="n">Checkpoint</span><span class="p">(</span>
            <span class="n">epoch</span><span class="o">=</span><span class="n">state</span><span class="o">.</span><span class="n">current_justified_checkpoint</span><span class="o">.</span><span class="n">epoch</span><span class="p">,</span>
            <span class="n">root</span><span class="o">=</span><span class="n">state</span><span class="o">.</span><span class="n">current_justified_checkpoint</span><span class="o">.</span><span class="n">root</span>
        <span class="p">)</span>
        
        <span class="n">tgt_checkpoint</span> <span class="o">=</span> <span class="n">Checkpoint</span><span class="p">(</span>
            <span class="n">epoch</span><span class="o">=</span><span class="n">current_epoch</span><span class="p">,</span>
            <span class="n">root</span><span class="o">=</span><span class="n">get_block_root</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">current_epoch</span><span class="p">)</span>
        <span class="p">)</span>
        
    <span class="n">att_data</span> <span class="o">=</span> <span class="n">AttestationData</span><span class="p">(</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">committee_index</span><span class="p">,</span>
        <span class="n">slot</span> <span class="o">=</span> <span class="n">committee_slot</span><span class="p">,</span>
        <span class="n">beacon_block_root</span> <span class="o">=</span> <span class="n">block_root</span><span class="p">,</span>
        <span class="n">source</span> <span class="o">=</span> <span class="n">src_checkpoint</span><span class="p">,</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">tgt_checkpoint</span>
    <span class="p">)</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;attestation for source&quot;</span><span class="p">,</span> <span class="n">src_checkpoint</span><span class="o">.</span><span class="n">epoch</span><span class="p">,</span> <span class="s2">&quot;and target&quot;</span><span class="p">,</span> <span class="n">tgt_checkpoint</span><span class="o">.</span><span class="n">epoch</span><span class="p">)</span>
    
    <span class="c1"># For now we disregard aggregation of attestations.</span>
    <span class="c1"># Some validators are chosen as aggregators: they take a bunch of identical attestations</span>
    <span class="c1"># and join them together in one object,</span>
    <span class="c1"># with `aggregation_bits` identifying which validators are part of the aggregation.</span>
    <span class="n">committee_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">committee</span><span class="p">)</span>
    <span class="n">index_in_committee</span> <span class="o">=</span> <span class="n">committee</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">validator_index</span><span class="p">)</span>
    <span class="n">aggregation_bits</span> <span class="o">=</span> <span class="n">Bitlist</span><span class="p">[</span><span class="n">MAX_VALIDATORS_PER_COMMITTEE</span><span class="p">](</span><span class="o">*</span><span class="p">([</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">committee_size</span><span class="p">))</span>
    <span class="n">aggregation_bits</span><span class="p">[</span><span class="n">index_in_committee</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span> <span class="c1"># set the aggregation bits of the validator to True</span>
    <span class="n">attestation</span> <span class="o">=</span> <span class="n">Attestation</span><span class="p">(</span>
        <span class="n">aggregation_bits</span><span class="o">=</span><span class="n">aggregation_bits</span><span class="p">,</span>
        <span class="n">data</span><span class="o">=</span><span class="n">att_data</span>
    <span class="p">)</span>
    
    <span class="k">return</span> <span class="n">attestation</span>
</pre></div>

     </div>
</div>
</div>
</div>

</details>

</div>
<div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput " data-mime-type="text/markdown">
<p>We can use this <code>honest_attest</code> function in our policy function for step #2, <code>honest_attest_policy</code>.</p>

</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs  ">
<details><summary>Input 19 (click to open)</summary>
<div class="jp-Cell-inputWrapper">
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In&nbsp;[19]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
     <div class="CodeMirror cm-s-jupyter">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">honest_attest_policy</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">sL</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
    <span class="c1"># Collect all attestations formed for slot s-1.</span>
    
    <span class="c1"># `state` is at w-[s]</span>
    <span class="n">state</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;beacon_state&#39;</span><span class="p">]</span>
    <span class="n">current_epoch</span> <span class="o">=</span> <span class="n">get_current_epoch</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
    <span class="n">previous_epoch</span> <span class="o">=</span> <span class="n">get_previous_epoch</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
    
    <span class="c1"># `validator_epoch` is the epoch of slot s-1.</span>
    <span class="c1"># - If the state is already ahead by one epoch, this is given by `previous_epoch`</span>
    <span class="c1"># - Otherwise it is `current_epoch`</span>
    <span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">slot</span> <span class="o">==</span> <span class="n">compute_start_slot_at_epoch</span><span class="p">(</span><span class="n">current_epoch</span><span class="p">):</span>
        <span class="n">validator_epoch</span> <span class="o">=</span> <span class="n">previous_epoch</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">validator_epoch</span> <span class="o">=</span> <span class="n">current_epoch</span>
        
    <span class="n">active_validator_indices</span> <span class="o">=</span> <span class="n">get_active_validator_indices</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">validator_epoch</span><span class="p">)</span>
    <span class="n">slot_attestations</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">for</span> <span class="n">validator_index</span> <span class="ow">in</span> <span class="n">active_validator_indices</span><span class="p">:</span>
        <span class="c1"># For each validator, check which committee they belong to</span>
        <span class="p">(</span><span class="n">committee</span><span class="p">,</span> <span class="n">committee_index</span><span class="p">,</span> <span class="n">committee_slot</span><span class="p">)</span> <span class="o">=</span> <span class="n">get_committee_assignment</span><span class="p">(</span>
            <span class="n">state</span><span class="p">,</span> <span class="n">validator_epoch</span><span class="p">,</span> <span class="n">validator_index</span>
        <span class="p">)</span>
        
        <span class="c1"># If they belong to a committee attesting for slot s-1, we ask them to form an attestation</span>
        <span class="c1"># using `honest_attest` defined above.</span>
        <span class="k">if</span> <span class="n">committee_slot</span><span class="o">+</span><span class="mi">1</span> <span class="o">==</span> <span class="n">state</span><span class="o">.</span><span class="n">slot</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;validator attesting&quot;</span><span class="p">,</span> <span class="n">validator_index</span><span class="p">,</span> <span class="s2">&quot;for slot&quot;</span><span class="p">,</span> <span class="n">committee_slot</span><span class="p">)</span>
            <span class="n">attestation</span> <span class="o">=</span> <span class="n">honest_attest</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">validator_index</span><span class="p">)</span>
            <span class="n">slot_attestations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">attestation</span><span class="p">)</span>
            
    <span class="k">return</span><span class="p">({</span> <span class="s1">&#39;slot_attestations&#39;</span><span class="p">:</span> <span class="n">slot_attestations</span> <span class="p">})</span>
</pre></div>

     </div>
</div>
</div>
</div>

</details>

</div>
<div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput " data-mime-type="text/markdown">
<h3 id="Keep-attestations-in-state">Keep attestations in state<a class="anchor-link" href="#Keep-attestations-in-state">&#182;</a></h3><p>Step #3 is easily handled with one single state update.</p>

</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs  ">
<details><summary>Input 20 (click to open)</summary>
<div class="jp-Cell-inputWrapper">
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In&nbsp;[20]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
     <div class="CodeMirror cm-s-jupyter">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">update_current_slot_attestations</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">sL</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">_input</span><span class="p">):</span>
    <span class="c1"># Take the output of `honest_attest_policy` and set it as `current_slot_attestations`</span>
    <span class="k">return</span><span class="p">(</span><span class="s1">&#39;current_slot_attestations&#39;</span><span class="p">,</span> <span class="n">_input</span><span class="p">[</span><span class="s1">&#39;slot_attestations&#39;</span><span class="p">])</span>
</pre></div>

     </div>
</div>
</div>
</div>

</details>

</div>
<div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput " data-mime-type="text/markdown">
<h3 id="Block-proposal-policy">Block proposal policy<a class="anchor-link" href="#Block-proposal-policy">&#182;</a></h3><p>We must update our block proposal policy to include latest attestations. This time, we do not include offline block proposers.</p>

</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs  ">
<details><summary>Input 21 (click to open)</summary>
<div class="jp-Cell-inputWrapper">
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In&nbsp;[21]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
     <div class="CodeMirror cm-s-jupyter">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">honest_block_proposal</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">attestations</span><span class="p">):</span>
    <span class="c1"># State is w-[s], block will be proposed for slot s</span>
    
    <span class="n">beacon_block_body</span> <span class="o">=</span> <span class="n">BeaconBlockBody</span><span class="p">(</span>
        <span class="n">attestations</span><span class="o">=</span><span class="n">attestations</span>
    <span class="p">)</span>
    
    <span class="n">beacon_block</span> <span class="o">=</span> <span class="n">BeaconBlock</span><span class="p">(</span>
        <span class="n">slot</span><span class="o">=</span><span class="n">state</span><span class="o">.</span><span class="n">slot</span><span class="p">,</span>
        <span class="c1"># the parent root is accessed from the state</span>
        <span class="n">parent_root</span><span class="o">=</span><span class="n">get_block_root_at_slot</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">slot</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span>
        <span class="n">body</span><span class="o">=</span><span class="n">beacon_block_body</span>
    <span class="p">)</span>
    <span class="n">signed_beacon_block</span> <span class="o">=</span> <span class="n">SignedBeaconBlock</span><span class="p">(</span><span class="n">message</span><span class="o">=</span><span class="n">beacon_block</span><span class="p">)</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;honest propose a block for slot&quot;</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">slot</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">signed_beacon_block</span>
</pre></div>

     </div>
</div>
</div>
</div>

</details>

</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs  ">
<details><summary>Input 22 (click to open)</summary>
<div class="jp-Cell-inputWrapper">
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In&nbsp;[22]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
     <div class="CodeMirror cm-s-jupyter">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">propose_block</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">sL</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
    <span class="c1"># Given state w-[s], propose a block for slot s</span>
    
    <span class="c1"># `state` is w-[s]</span>
    <span class="n">state</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;beacon_state&#39;</span><span class="p">]</span>
    <span class="c1"># We get the output of our honest attestation policy</span>
    <span class="n">attestations</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;current_slot_attestations&#39;</span><span class="p">]</span>
    
    <span class="n">block</span> <span class="o">=</span> <span class="n">honest_block_proposal</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">attestations</span><span class="p">)</span>
        
    <span class="k">return</span> <span class="p">({</span> <span class="s1">&#39;block&#39;</span><span class="p">:</span> <span class="n">block</span> <span class="p">})</span>
</pre></div>

     </div>
</div>
</div>
</div>

</details>

</div>
<div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput " data-mime-type="text/markdown">
<h3 id="Process-block">Process block<a class="anchor-link" href="#Process-block">&#182;</a></h3><p>We also have a state update for this step, <code>state_update_block</code>, which we do not need to change.</p>

</div>
<div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput " data-mime-type="text/markdown">
<h3 id="Simulation-time!">Simulation time!<a class="anchor-link" href="#Simulation-time!">&#182;</a></h3><p>Our PSUB array becomes:</p>

</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs  ">
<details><summary>Input 23 (click to open)</summary>
<div class="jp-Cell-inputWrapper">
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In&nbsp;[23]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
     <div class="CodeMirror cm-s-jupyter">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">block_attestation_psub</span> <span class="o">=</span> <span class="p">[</span>
    <span class="c1"># Step 1</span>
    <span class="p">{</span>
        <span class="s1">&#39;policies&#39;</span><span class="p">:{</span>
        <span class="p">},</span>
        <span class="s1">&#39;variables&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;beacon_state&#39;</span><span class="p">:</span> <span class="n">state_update_slot</span>
        <span class="p">}</span>
    <span class="p">},</span>
    <span class="c1"># Step 2+3</span>
    <span class="p">{</span>
        <span class="s1">&#39;policies&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="n">honest_attest_policy</span>
        <span class="p">},</span>
        <span class="s1">&#39;variables&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;current_slot_attestations&#39;</span><span class="p">:</span> <span class="n">update_current_slot_attestations</span>
        <span class="p">}</span>
    <span class="p">},</span>
    <span class="c1"># Step 4+5</span>
    <span class="p">{</span>
        <span class="s1">&#39;policies&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="n">propose_block</span>
        <span class="p">},</span>
        <span class="s1">&#39;variables&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;beacon_state&#39;</span><span class="p">:</span> <span class="n">state_update_block</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">]</span>
</pre></div>

     </div>
</div>
</div>
</div>

</details>

</div>
<div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput " data-mime-type="text/markdown">
<p>We need to change our initial conditions to add the <code>current_slot_attestations</code> state attribute, which starts out empty. To keep the overhead low, we set a low number of validators and run the simulation for 20 slots.</p>

</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs  ">
<details><summary>Input 24 (click to open)</summary>
<div class="jp-Cell-inputWrapper">
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In&nbsp;[24]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
     <div class="CodeMirror cm-s-jupyter">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%capture</span>

<span class="n">num_validators</span> <span class="o">=</span> <span class="mi">10</span>

<span class="n">genesis_state</span> <span class="o">=</span> <span class="n">initialize_beacon_state_from_eth1</span><span class="p">(</span>
    <span class="n">block_hash</span><span class="p">,</span> <span class="n">eth1_timestamp</span><span class="p">,</span> <span class="n">get_initial_deposits</span><span class="p">(</span><span class="n">num_validators</span><span class="p">)</span>
<span class="p">)</span>

<span class="n">initial_conditions</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;beacon_state&#39;</span><span class="p">:</span> <span class="n">genesis_state</span><span class="p">,</span>
    <span class="s1">&#39;current_slot_attestations&#39;</span><span class="p">:</span> <span class="p">[]</span>
<span class="p">}</span>

<span class="n">simulation_parameters</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;T&#39;</span><span class="p">:</span> <span class="nb">range</span><span class="p">(</span><span class="mi">20</span><span class="p">),</span>
    <span class="s1">&#39;N&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s1">&#39;M&#39;</span><span class="p">:</span> <span class="p">{}</span>
<span class="p">}</span>
</pre></div>

     </div>
</div>
</div>
</div>

</details>

</div>
<div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput " data-mime-type="text/markdown">
<p>We define the configuration object again, and run our simulation.</p>

</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs  ">
<details><summary>Input 25 (click to open)</summary>
<div class="jp-Cell-inputWrapper">
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In&nbsp;[25]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
     <div class="CodeMirror cm-s-jupyter">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">config</span> <span class="o">=</span> <span class="n">Configuration</span><span class="p">(</span><span class="n">initial_state</span><span class="o">=</span><span class="n">initial_conditions</span><span class="p">,</span>
                       <span class="n">partial_state_update_blocks</span><span class="o">=</span><span class="n">block_attestation_psub</span><span class="p">,</span>
                       <span class="n">sim_config</span><span class="o">=</span><span class="n">simulation_parameters</span>
                      <span class="p">)</span>
</pre></div>

     </div>
</div>
</div>
</div>

</details>

</div>
<div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput " data-mime-type="text/markdown">
<p>Here we leave the execution trace visible. Use a <code>%%capture</code> directive at the top of the following cell to hide it.</p>

</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell   ">
<details><summary>Input 26 (click to open)</summary>
<div class="jp-Cell-inputWrapper">
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In&nbsp;[26]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
     <div class="CodeMirror cm-s-jupyter">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">exec_mode</span> <span class="o">=</span> <span class="n">ExecutionMode</span><span class="p">()</span>
<span class="n">exec_context</span> <span class="o">=</span> <span class="n">ExecutionContext</span><span class="p">(</span><span class="n">exec_mode</span><span class="o">.</span><span class="n">single_proc</span><span class="p">)</span>
<span class="n">executor</span> <span class="o">=</span> <span class="n">Executor</span><span class="p">(</span><span class="n">exec_context</span><span class="p">,</span> <span class="p">[</span><span class="n">config</span><span class="p">])</span> <span class="c1"># Pass the configuration object inside an array</span>
<span class="n">raw_result</span><span class="p">,</span> <span class="n">tensor</span> <span class="o">=</span> <span class="n">executor</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span> <span class="c1"># The `execute()` method returns a tuple; its first elements contains the raw results</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">raw_result</span><span class="p">)</span>
</pre></div>

     </div>
</div>
</div>
</div>

</details>

<div class="jp-Cell-outputWrapper">


<div class="jp-OutputArea jp-Cell-outputArea">

<div class="jp-OutputArea-child">

    
    <div class="jp-OutputPrompt jp-OutputArea-prompt"></div>


<div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain">
<pre>
                            __________   ____ 
          ________ __ _____/ ____/   |  / __ \
         / ___/ __` / __  / /   / /| | / / / /
        / /__/ /_/ / /_/ / /___/ ___ |/ /_/ / 
        \___/\__,_/\__,_/\____/_/  |_/_____/  
        by BlockScience
        
Execution Mode: single_proc: [&lt;cadCAD.configuration.Configuration object at 0x1351ebbe0&gt;]
Configurations: [&lt;cadCAD.configuration.Configuration object at 0x1351ebbe0&gt;]
validator attesting 3 for slot 0
attestation for source 0 and target 0
validator attesting 5 for slot 0
attestation for source 0 and target 0
honest propose a block for slot 1
validator attesting 0 for slot 1
attestation for source 0 and target 0
validator attesting 6 for slot 1
attestation for source 0 and target 0
validator attesting 7 for slot 1
attestation for source 0 and target 0
honest propose a block for slot 2
validator attesting 4 for slot 2
attestation for source 0 and target 0
validator attesting 8 for slot 2
attestation for source 0 and target 0
honest propose a block for slot 3
START PROCESS EPOCH 0
not processing justification and finalization
END PROCESS EPOCH
validator attesting 1 for slot 3
attestation for source 0 and target 0
validator attesting 2 for slot 3
attestation for source 0 and target 0
validator attesting 9 for slot 3
attestation for source 0 and target 0
honest propose a block for slot 4
validator attesting 0 for slot 4
attestation for source 0 and target 1
validator attesting 3 for slot 4
attestation for source 0 and target 1
honest propose a block for slot 5
validator attesting 2 for slot 5
attestation for source 0 and target 1
validator attesting 4 for slot 5
attestation for source 0 and target 1
validator attesting 8 for slot 5
attestation for source 0 and target 1
honest propose a block for slot 6
validator attesting 6 for slot 6
attestation for source 0 and target 1
validator attesting 7 for slot 6
attestation for source 0 and target 1
honest propose a block for slot 7
START PROCESS EPOCH 1
not processing justification and finalization
END PROCESS EPOCH
validator attesting 1 for slot 7
attestation for source 0 and target 1
validator attesting 5 for slot 7
attestation for source 0 and target 1
validator attesting 9 for slot 7
attestation for source 0 and target 1
honest propose a block for slot 8
validator attesting 4 for slot 8
attestation for source 0 and target 2
validator attesting 8 for slot 8
attestation for source 0 and target 2
honest propose a block for slot 9
validator attesting 0 for slot 9
attestation for source 0 and target 2
validator attesting 2 for slot 9
attestation for source 0 and target 2
validator attesting 9 for slot 9
attestation for source 0 and target 2
honest propose a block for slot 10
validator attesting 1 for slot 10
attestation for source 0 and target 2
validator attesting 6 for slot 10
attestation for source 0 and target 2
honest propose a block for slot 11
START PROCESS EPOCH 2
old_previous 0
old_current 0
new current justified checkpoint 1
new current justified checkpoint 2
justification bits Bitvector[boolean, 4](1, 1, 0, 0)
finalised checkpoint 0
END PROCESS EPOCH
validator attesting 3 for slot 11
attestation for source 0 and target 2
validator attesting 5 for slot 11
attestation for source 0 and target 2
validator attesting 7 for slot 11
attestation for source 0 and target 2
honest propose a block for slot 12
validator attesting 2 for slot 12
attestation for source 2 and target 3
validator attesting 3 for slot 12
attestation for source 2 and target 3
honest propose a block for slot 13
validator attesting 0 for slot 13
attestation for source 2 and target 3
validator attesting 6 for slot 13
attestation for source 2 and target 3
validator attesting 7 for slot 13
attestation for source 2 and target 3
honest propose a block for slot 14
validator attesting 8 for slot 14
attestation for source 2 and target 3
validator attesting 9 for slot 14
attestation for source 2 and target 3
honest propose a block for slot 15
START PROCESS EPOCH 3
old_previous 0
old_current 2
new current justified checkpoint 2
new current justified checkpoint 3
justification bits Bitvector[boolean, 4](1, 1, 1, 0)
finalised checkpoint 2
END PROCESS EPOCH
validator attesting 1 for slot 15
attestation for source 2 and target 3
validator attesting 4 for slot 15
attestation for source 2 and target 3
validator attesting 5 for slot 15
attestation for source 2 and target 3
honest propose a block for slot 16
validator attesting 0 for slot 16
attestation for source 3 and target 4
validator attesting 5 for slot 16
attestation for source 3 and target 4
honest propose a block for slot 17
validator attesting 4 for slot 17
attestation for source 3 and target 4
validator attesting 6 for slot 17
attestation for source 3 and target 4
validator attesting 8 for slot 17
attestation for source 3 and target 4
honest propose a block for slot 18
validator attesting 1 for slot 18
attestation for source 3 and target 4
validator attesting 3 for slot 18
attestation for source 3 and target 4
honest propose a block for slot 19
START PROCESS EPOCH 4
old_previous 2
old_current 3
new current justified checkpoint 3
new current justified checkpoint 4
justification bits Bitvector[boolean, 4](1, 1, 1, 1)
finalised checkpoint 3
END PROCESS EPOCH
validator attesting 2 for slot 19
attestation for source 3 and target 4
validator attesting 7 for slot 19
attestation for source 3 and target 4
validator attesting 9 for slot 19
attestation for source 3 and target 4
honest propose a block for slot 20
</pre>
</div>
</div>

</div>

</div>

</div>
<div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput " data-mime-type="text/markdown">
<p>Let's check the dataframe to make sure our state updates are correct. Since we have several partial updates blocks, we will have several substeps at each timestep. We give the length of the number of attestations in column <code>num_attestations</code>. They add up to 10 over each epoch, as we have 10 validators.</p>

</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell   ">
<details><summary>Input 27 (click to open)</summary>
<div class="jp-Cell-inputWrapper">
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In&nbsp;[27]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
     <div class="CodeMirror cm-s-jupyter">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;num_attestations&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">current_slot_attestations</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="nb">len</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;epoch&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">beacon_state</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">get_current_epoch</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">substep</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="mi">3</span><span class="p">:</span><span class="mi">8</span><span class="p">]</span>
</pre></div>

     </div>
</div>
</div>
</div>

</details>

<div class="jp-Cell-outputWrapper">


<div class="jp-OutputArea jp-Cell-outputArea">

<div class="jp-OutputArea-child">

    
    <div class="jp-OutputPrompt jp-OutputArea-prompt">Out[27]:</div>



<div class="jp-RenderedHTMLCommon jp-RenderedHTML jp-OutputArea-output jp-OutputArea-executeResult" data-mime-type="text/html">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>substep</th>
      <th>timestep</th>
      <th>num_attestations</th>
      <th>epoch</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>1</td>
      <td>0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1</td>
      <td>2</td>
      <td>2</td>
      <td>0</td>
    </tr>
    <tr>
      <th>7</th>
      <td>1</td>
      <td>3</td>
      <td>3</td>
      <td>0</td>
    </tr>
    <tr>
      <th>10</th>
      <td>1</td>
      <td>4</td>
      <td>2</td>
      <td>1</td>
    </tr>
    <tr>
      <th>13</th>
      <td>1</td>
      <td>5</td>
      <td>3</td>
      <td>1</td>
    </tr>
    <tr>
      <th>16</th>
      <td>1</td>
      <td>6</td>
      <td>2</td>
      <td>1</td>
    </tr>
    <tr>
      <th>19</th>
      <td>1</td>
      <td>7</td>
      <td>3</td>
      <td>1</td>
    </tr>
    <tr>
      <th>22</th>
      <td>1</td>
      <td>8</td>
      <td>2</td>
      <td>2</td>
    </tr>
    <tr>
      <th>25</th>
      <td>1</td>
      <td>9</td>
      <td>3</td>
      <td>2</td>
    </tr>
    <tr>
      <th>28</th>
      <td>1</td>
      <td>10</td>
      <td>2</td>
      <td>2</td>
    </tr>
    <tr>
      <th>31</th>
      <td>1</td>
      <td>11</td>
      <td>3</td>
      <td>2</td>
    </tr>
    <tr>
      <th>34</th>
      <td>1</td>
      <td>12</td>
      <td>2</td>
      <td>3</td>
    </tr>
    <tr>
      <th>37</th>
      <td>1</td>
      <td>13</td>
      <td>3</td>
      <td>3</td>
    </tr>
    <tr>
      <th>40</th>
      <td>1</td>
      <td>14</td>
      <td>2</td>
      <td>3</td>
    </tr>
    <tr>
      <th>43</th>
      <td>1</td>
      <td>15</td>
      <td>3</td>
      <td>3</td>
    </tr>
    <tr>
      <th>46</th>
      <td>1</td>
      <td>16</td>
      <td>2</td>
      <td>4</td>
    </tr>
    <tr>
      <th>49</th>
      <td>1</td>
      <td>17</td>
      <td>3</td>
      <td>4</td>
    </tr>
    <tr>
      <th>52</th>
      <td>1</td>
      <td>18</td>
      <td>2</td>
      <td>4</td>
    </tr>
    <tr>
      <th>55</th>
      <td>1</td>
      <td>19</td>
      <td>3</td>
      <td>4</td>
    </tr>
    <tr>
      <th>58</th>
      <td>1</td>
      <td>20</td>
      <td>2</td>
      <td>5</td>
    </tr>
  </tbody>
</table>
</div>
</div>

</div>

</div>

</div>

</div>
<div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput " data-mime-type="text/markdown">
<p>We can check the balances of our validators.</p>

</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell   ">
<details><summary>Input 28 (click to open)</summary>
<div class="jp-Cell-inputWrapper">
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In&nbsp;[28]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
     <div class="CodeMirror cm-s-jupyter">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">60</span><span class="p">][</span><span class="s1">&#39;beacon_state&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">balances</span>
</pre></div>

     </div>
</div>
</div>
</div>

</details>

<div class="jp-Cell-outputWrapper">


<div class="jp-OutputArea jp-Cell-outputArea">

<div class="jp-OutputArea-child">

    
    <div class="jp-OutputPrompt jp-OutputArea-prompt">Out[28]:</div>




<div class="jp-RenderedText jp-OutputArea-output jp-OutputArea-executeResult" data-mime-type="text/plain">
<pre>List[Gwei, 1099511627776](32014368415, 32014820963, 32014594689, 32014255278, 32014707826, 32014594689, 32014481552, 32014368415, 32014368415, 32014255278)</pre>
</div>

</div>

</div>

</div>

</div>
<div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput " data-mime-type="text/markdown">
<p>Note that they are getting rewarded for attesting correctly, with balances greater than the initial 32 ETH they started with, but some are more rewarded than others: this is the randomness of the block proposal. If you picked a low <code>num_validators</code>, you will notice that rewards are quite high. This is due to the variable rate of reward, which increases when the supply of validators is low. In practice, for 1,000,000 ETH at stake, we ought to have about 30,000 validators.</p>
<p>We can also check that we are finalising checkpoints.</p>

</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell   ">
<details><summary>Input 29 (click to open)</summary>
<div class="jp-Cell-inputWrapper">
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In&nbsp;[29]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
     <div class="CodeMirror cm-s-jupyter">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">60</span><span class="p">][</span><span class="s1">&#39;beacon_state&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">finalized_checkpoint</span>
</pre></div>

     </div>
</div>
</div>
</div>

</details>

<div class="jp-Cell-outputWrapper">


<div class="jp-OutputArea jp-Cell-outputArea">

<div class="jp-OutputArea-child">

    
    <div class="jp-OutputPrompt jp-OutputArea-prompt">Out[29]:</div>




<div class="jp-RenderedText jp-OutputArea-output jp-OutputArea-executeResult" data-mime-type="text/plain">
<pre>{&#39;epoch&#39;: 3, &#39;root&#39;: b&#39;Ow\x85\xce\x9e{\xf8\xb9E.\xe5\xd4SK,L^\xeay\x85\xd1[\x99\x81\xdfy\xb2\xc9a@U\xd8&#39;}</pre>
</div>

</div>

</div>

</div>

</div>
<div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput " data-mime-type="text/markdown">
<p>Indeed, the latest finalised checkpoint is at epoch 3!</p>
<p>Let's plot the total rewards given out to validators (the "issuance"). First we add a column to our dataframe holding the net profits from state balances.</p>

</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs  ">
<details><summary>Input 30 (click to open)</summary>
<div class="jp-Cell-inputWrapper">
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In&nbsp;[30]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
     <div class="CodeMirror cm-s-jupyter">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;total_balance&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">beacon_state</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
    <span class="k">lambda</span> <span class="n">state</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">balances</span><span class="p">)</span> <span class="o">-</span> <span class="n">eth_to_gwei</span><span class="p">(</span><span class="mi">32</span> <span class="o">*</span> <span class="n">num_validators</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>

     </div>
</div>
</div>
</div>

</details>

</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs  ">
<details><summary>Input 31 (click to open)</summary>
<div class="jp-Cell-inputWrapper">
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In&nbsp;[31]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
     <div class="CodeMirror cm-s-jupyter">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%</span><span class="k">matplotlib</span> inline
</pre></div>

     </div>
</div>
</div>
</div>

</details>

</div><div class="jp-Cell jp-CodeCell jp-Notebook-cell   ">
<details><summary>Input 32 (click to open)</summary>
<div class="jp-Cell-inputWrapper">
<div class="jp-InputArea jp-Cell-inputArea">
<div class="jp-InputPrompt jp-InputArea-prompt">In&nbsp;[32]:</div>
<div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
     <div class="CodeMirror cm-s-jupyter">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">substep</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="s1">&#39;timestep&#39;</span><span class="p">,</span> <span class="s1">&#39;total_balance&#39;</span><span class="p">)</span>
</pre></div>

     </div>
</div>
</div>
</div>

</details>

<div class="jp-Cell-outputWrapper">


<div class="jp-OutputArea jp-Cell-outputArea">

<div class="jp-OutputArea-child">

    
    <div class="jp-OutputPrompt jp-OutputArea-prompt">Out[32]:</div>




<div class="jp-RenderedText jp-OutputArea-output jp-OutputArea-executeResult" data-mime-type="text/plain">
<pre>&lt;matplotlib.axes._subplots.AxesSubplot at 0x138e48fd0&gt;</pre>
</div>

</div>

<div class="jp-OutputArea-child">

    
    <div class="jp-OutputPrompt jp-OutputArea-prompt"></div>




<div class="jp-RenderedImage jp-OutputArea-output ">
<img src="data:image/png;base64,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
"
>
</div>

</div>

</div>

</div>

</div>
<div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput " data-mime-type="text/markdown">
<p>It's kind of nice to see a small economy grow before your very eyes no? Like gardening.</p>
<p>Now how can we extend this model?</p>
<ul>
<li>We can define very specific validation behaviour and test what happens under different scenarios. Here we have focused on the "honest" behaviour, which is hopefully what validators on eth2 will follow. But hope is not enough, so much like <a href="https://hackingresear.ch/diaries/anarchy-creta">mining in Proof-of-Work, it remains to prove that good behaviour in the protocol exactly corresponds to rational behaviour in the <em>game</em> defined by the protocol</a>.</li>
<li>We can also tweak state updates to represent network delays and modify the information basis of validators, who we assumed here always have the latest data to make their attestations. This may be a good use case for cadCAD's support for stochastic simulations (where execution may depend on chance events).</li>
</ul>
<p>Some efforts should also be spent making the simulation lighter to execute, so that larger models can be tested, including stochastic events using Monte-Carlo methods which require repeating executions a significant amount of times.</p>

</div>
<div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput " data-mime-type="text/markdown">
<hr>
<p><em>Some other cool resources</em>:</p>
<ul>
<li><a href="https://github.com/BlockScience/uniswap/blob/master/simplified-uniswap.ipynb">Uniswap bonding curves with cadCAD</a></li>
<li><a href="https://notes.ethereum.org/@hww/aggregation">Attestations and aggregators, a note by Hsiao-Wei Wang</a></li>
</ul>

</div>




    </div>
  </div>
  <script>
  // References + footnotes

// Authors
let authorData = ["barnabe"];
  </script>

  
</body>

  <div id="footer"></div>
    <script>
    ReactDOM.render(
      e(
        Footer, {
          acknowledgements: 'Danny Ryan for answering my questions about the specs; Michael Zargham and Markus Koch for their work on cadCAD and introducing me to it; and v for all your help.',
        }
      ),
      document.querySelector("#footer")
    )

    const copyToClipboard = str => {
      const el = document.createElement("textarea") // Create a <textarea> element
      el.value = str // Set its value to the string that you want copied
      el.setAttribute("readonly", "") // Make it readonly to be tamper-proof
      el.style.position = "absolute"
      el.style.left = "-9999px" // Move outside the screen to make it invisible
      document.body.appendChild(el) // Append the <textarea> element to the HTML document
      const selected =
        document.getSelection().rangeCount > 0 // Check if there is any content selected previously
          ? document.getSelection().getRangeAt(0) // Store selection if found
          : false // Mark as false to know no selection existed before
      el.select() // Select the <textarea> content
      document.execCommand("copy") // Copy - only works as a result of a user action (e.g. click events)
      document.body.removeChild(el) // Remove the <textarea> element
      if (selected) {
        // If a selection existed before copying
        document.getSelection().removeAllRanges() // Unselect everything on the HTML document
        document.getSelection().addRange(selected) // Restore the original selection
      }
    }
    function handleCopyClick(evt) {
      // get the children of the parent element
      const { children } = evt.target.parentElement
      // grab the first element (we append the copy button on afterwards, so the first will be the code element)
      // destructure the innerText from the code block
      const { innerText } = Array.from(children)[0]
      // copy all of the code to the clipboard
      copyToClipboard(innerText)
    }

    const highlights = document.querySelectorAll(".jp-InputArea-editor .highlight")

    highlights.forEach(div => {
      // create the copy button
      const copy = document.createElement("button")
      copy.innerHTML = "Copy"
      // add the event listener to each click
      copy.addEventListener("click", handleCopyClick)
      // append the copy button to each code block
      div.append(copy)
    })
    </script>
  </div>
  <script src="https://ethereum.github.io/rig/static/authorFormatting.js"></script>
  <script src="https://ethereum.github.io/rig/static/sectionFormatting.js"></script>
  <script src="https://ethereum.github.io/rig/static/referencesFormatting.js"></script>







</html>
